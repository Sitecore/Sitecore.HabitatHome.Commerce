// ------------------------------------------------------------------------------------------------------ //
//         Sitecore Install Framework - Commerce Single Server Configuration                              //
//                                                                                                        //
//  Run this configuration to install a single instance of Commerce Engine and Sitecore Storefront Site.  //
//																										  //
//                                                                                                        //
//  NOTE: Only single line comments are accepted in configurations.                                       //
// ------------------------------------------------------------------------------------------------------ //
{
  "Parameters": {
    // Parameters are values that may be passed when Install-SitecoreConfiguration is called.
    // Parameters must declare a Type and may declare a DefaultValue and Description.
    // Parameters with no DefaultValue are required when Install-SitecoreConfiguration is called.
    "BaseConfigurationFolder":{
      "Type":"string",
      "Description":"The base folder where configurations are stored"
    },
    "InstallDir": {
      "Type": "string",
      "Description": "The sitecore site content path."
    },
    "SiteUtilitiesSrc": {
      "Type": "string",
      "Description": "Site Utilities source path"
    },
    "SiteHostHeaderName": {
      "Type": "string",
      "Description": "The host header name of the site to be deployed."
    },
    "HabitatImagesModuleFullPath": {
      "Type": "string",
      "Description": "Habitat Images module full path"
    }
  },
  "Variables": {
    // Variables are values calculated in a configuration.
    // They can reference Parameters, other Variables, and config functions.
    "SiteUtilitiesDir": "[concat(parameter('InstallDir'), '\\SiteUtilityPages')]",
    "ModulesDirDst": "[concat(parameter('InstallDir'), '\\App_Data\\packages')]",
    "UtilitiesBaseUrl": "[concat('https://', concat(parameter('SiteHostHeaderName'), '/SiteUtilityPages'))]",
    "MarketingConfigDir": "[concat(parameter('InstallDir'), '\\App_Config\\Sitecore\\Marketing.Operations.xMgmt')]",
    "ContentSearchConfig": "[concat(parameter('InstallDir'), '\\App_Config\\Sitecore\\ContentSearch\\Sitecore.ContentSearch.config')]",
    "ContentSearchEnabledXpath": "//configuration/sitecore/settings/setting[@name='ContentSearch.Enabled']",
    "ContentSearchEnabledXpath": "//configuration/sitecore/settings/setting[@name='ContentSearch.Enabled']"
  },
  "Modules": [ "InstallSitecoreConfiguration", "ManageCommerceService", "SitecoreUtilityTasks" ],
  "Tasks": {
  
    "CopySiteUtilityFolder": {
      "Type": "Copy",
      "Params": {
        "Source": "[parameter('SiteUtilitiesSrc')]",
        "Destination": "[parameter('InstallDir')]"
      }
    },
    "DisableIndexUpdate": {
      // Speed up deployment
      "Type": "SetXml",
      "Params": [
        {
          "FilePath": "[variable('ContentSearchConfig'))]",
          "Xpath": "[variable('ContentSearchEnabledXpath')]",
          "Attributes": {
            "value": "false"
          }
        }
      ]
    },
    "DisableConfigFiles": {
      // Speed up deployment
      "Type": "DisableConfigFiles",
      "Params": {
        "ConfigDir": "[variable('MarketingConfigDir')]",
        "ConfigFileList": [ "Sitecore.Marketing.Search.config" ]
      }
    },
    "EnableIndexUpdate": {
      "Type": "SetXml",
      "Params": [
        {
          "FilePath": "[variable('ContentSearchConfig'))]",
          "Xpath": "[variable('ContentSearchEnabledXpath')]",
          "Attributes": {
            "value": "true"
          }
        }
      ]
    },
    "EnableConfigFiles": {
      "Type": "EnableConfigFiles",
      "Params": {
        "ConfigDir": "[variable('MarketingConfigDir')]",
        "ConfigFileList": [ "Sitecore.Marketing.Search.config" ]
      }
    },
    "InstallHabitatImagesModule": {
      "Type": "InstallSitecoreConfiguration",
      "Params": {
        "Path": "[concat(parameter('BaseConfigurationFolder'), '\\Commerce\\HabitatImages\\HabitatImages.json')]",
        "ModuleFullPath": "[parameter('HabitatImagesModuleFullPath')]",
        "ModulesDirDst": "[variable('ModulesDirDst')]",
        "BaseUrl": "[variable('UtilitiesBaseUrl')]"
      }
    },
    "Reindex": {
      "Type": "InstallSitecoreConfiguration",
      "Params": {
        "Path": "[concat(parameter('BaseConfigurationFolder'), '\\SitecoreUtilities\\RebuildIndexes.json')]",
        "BaseUrl": "[variable('UtilitiesBaseUrl')]"
      }
    },
    "RemoveSiteUtilityFolder": {
      "Type": "ManageCommerceService",
      "Params": {
        "Name": "Name",
        "PhysicalPath": "[variable('SiteUtilitiesDir')]",
        "Action": "Remove-Item"
      }
    }
  }
}
