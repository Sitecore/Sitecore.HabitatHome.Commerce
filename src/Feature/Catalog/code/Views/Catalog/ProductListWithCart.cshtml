@using System.Web.Mvc.Ajax
@using System.Web.Mvc.Html
@using Sitecore.XA.Foundation.MarkupDecorator.Extensions
@using Sitecore.XA.Foundation.SitecoreExtensions.Extensions
@using Sitecore.Commerce.XA.Feature.Catalog.Models
@using Sitecore.Mvc
@model Sitecore.Commerce.XA.Feature.Catalog.Models.ProductListRenderingModel

@{
    var currentItem = Html.Sitecore().CurrentItem;
    var loadMoreProductsText = Html.Sitecore().Field("Show More Products Text", currentItem);
    var quantityLabel = Html.Sitecore().Field("Quantity Label", Html.Sitecore().CurrentItem);
    var addToCartLabel = Html.Sitecore().Field("Add to Cart Button Label", Html.Sitecore().CurrentItem);
    var addingToCartLabel = Html.Sitecore().CurrentItem["Add to Cart Button In-progress Label"];
}

<div @Html.Sxa().Component("cxa-productlist-component", Model.Attributes) data-cxa-component-class="ProductList" data-cxa-component-initialized="false" data-cxa-component-type="component">
    <input type="hidden" name="currentCatalogItemId" value="@Model.CurrentCatalogItemId" data-bind="value: currentCatalogItemId" />
    <input type="hidden" name="useLazyLoading" value="@Model.UseLazyLoading" data-bind="value: useLazyLoading" />
    <input type="hidden" name="maxPageSize" value="@Model.MaxPageSize" data-bind="value: maxPageSize" />
    <input type="hidden" name="currentItemId" value="@currentItem.ID" data-bind="value: currentItemId" />
    @if (!String.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="error-message">
            @Model.ErrorMessage
        </div>
    }
    else
    {
        if (Model.ShowNoResultMessage && (Model.ChildProducts == null || Model.ChildProducts.Count() == 0))
        {
            var message = Html.Sitecore().Field("No Result Message", Html.Sitecore().CurrentItem).ToString();
            message = message.Replace("[SearchKeyword]", Model.SearchKeyword);

            <div class="no-result-message">
                @Html.Raw(message)
            </div>
        }
        <div class="product-list product-list-with-cart">
            <ul data-bind="foreach: products">
                    <li>
                        <div class="product-summary">
                            <div class="photo">
                                <a data-bind="attr:{href: Link}">
                                    <img data-bind="attr:{src: SummaryImageUrl, title: DisplayName}" alt="product image"/>
                                </a>
                            </div>

                            <div class="product-info">
                                <h4 class="product-title" data-bind="attr:{title: DisplayName}">
                                    <a data-bind="attr:{href: Link}, text: DisplayName"></a>
                                </h4>
                                <!-- ko if: Brand-->
                                <div data-bind="html: Brand" class="product-brand"></div>
                                <!-- /ko-->
                                <!-- ko ifnot: Brand-->
                                <div class="product-brand">&nbsp;</div>
                                <!-- /ko -->
                                <!-- ko ifnot: IsCategory-->
                                <!-- ko if: DisplayStartingFrom -->
                                <div class="lowest-variant-price" data-bind="html: PriceStartingFromText"></div>
                                <!-- /ko -->
                                <!-- ko if: IsOnSale-->
                                <div class="current-price on-sale" data-bind="text: AdjustedPriceWithCurrency"></div>
                                <div class="previous-price on-sale" data-bind="text: ListPriceWithCurrency"></div>
                                <div class="savings on-sale">
                                    <span class="savings-text" data-bind="html: SavePercentLead"></span>
                                    <span class="savings-percentage" data-bind="text:SavingsPercentage+'%'"></span>
                                </div>
                                <!-- /ko -->
                                <!-- ko ifnot: IsOnSale-->
                                <div class="current-price" data-bind="text: ListPriceWithCurrency"></div>
                                <div class="previous-price"></div>
                                <div class="savings"></div>
                                <div></div>
                                <!-- /ko -->
                                <!-- ko if: StockStatus -->
                                <div data-bind="text: StockStatusName, attr:{class: StockStatusName + ' product-stock-status'}"></div>

                                <!-- ko if: StockAvailabilityDate -->
                                <div class="product-stock-availability-date" data-bind="text: '/' + StockAvailabilityDate"></div>
                                <!-- /ko -->
                                <!-- ko ifnot: StockAvailabilityDate -->
                                <div class="product-stock-availability-date"></div>
                                <!-- /ko -->
                                <!-- /ko -->
                                <!-- ko ifnot: StockStatus -->
                                <div class="product-stock-status">&nbsp;</div>
                                <div class="price-stock"></div>
                                <!-- /ko -->

                                <div class="product-rating">
                                    <ul>
                                        <li data-bind="css:{'rated' : CustomerAverageRating>= 1}"><span class="icon-star"></span></li>
                                        <li data-bind="css:{'rated' : CustomerAverageRating>= 2}"><span class="icon-star"></span></li>
                                        <li data-bind="css:{'rated' : CustomerAverageRating>= 3}"><span class="icon-star"></span></li>
                                        <li data-bind="css:{'rated' : CustomerAverageRating>= 4}"><span class="icon-star"></span></li>
                                        <li data-bind="css:{'rated' : CustomerAverageRating>= 5}"><span class="icon-star"></span></li>
                                    </ul>
                                </div>

                                <!-- ko if:IsOnSale -->
                                <div class="product-category on-sale">
                                    <a data-bind="attr:{href: Link}">
                                        <span class="icon-list"></span><span data-bind="html: ProductPageLinkText"></span>
                                    </a>
                                </div>
                                <!-- /ko -->
                                <!-- ko ifnot: IsOnSale -->
                                <div class="product-category">
                                    <a data-bind="attr:{href: Link}">
                                        <span class="icon-list"></span><span data-bind="html: ProductPageLinkText"></span>
                                    </a>
                                </div>
                                <!-- /ko -->
                                <!-- /ko -->
                                <!-- ko if: IsCategory-->
                                <!-- ko if: IsOnSale-->
                                <div class="product-category on-sale">
                                    <a data-bind="attr: {href: Link}">
                                        <span class="icon-list"></span><span data-bind="html: Category"></span>
                                    </a>
                                </div>
                                <!-- /ko -->
                                <!-- ko ifnot: IsOnSale-->
                                <div class="product-category">
                                    <a data-bind="attr: {href: Link}">
                                        <span class="icon-list"></span><span data-bind="html: Category"></span>
                                    </a>
                                </div>
                                <!-- /ko -->
                                <!-- /ko -->
                                <div class="component-content cxa-addtocart-component">

                                    @using (Ajax.BeginForm("AddCartLine", "CatalogWithCart", null, new AjaxOptions { OnSuccess = "AddToCartForm.OnSuccess", HttpMethod = "Post" }))
    {
                                @Html.Hidden("addtocart_catalogname", string.Empty, new { data_bind = "attr: {value: CatalogName}" })
                                @Html.Hidden("addtocart_productid", string.Empty, new { data_bind = "attr: {value: ProductId}" })
                                @Html.Hidden("addtocart_variantid", string.Empty, new { data_bind = "attr: {value: CatalogName}" })

                                @Html.ValidationSummary(true)
                                @Html.AntiForgeryToken()

                                <div class="add-to-cart-qty">
                                    <label class="quantity-label">@quantityLabel</label>
                                    <div class="quantity-input">
                                        <button type="button" class="decrease" style="display: none"></button>
                                        @Html.TextBox("quantity1", new { data_bind = "attr: {value: CatalogName}", @type = "number", @min = "1", @max = "100", @required = "required", @Value = "1", @class = "add-to-cart-qty-input" })
                                        @Html.TextBoxFor(model => model.CurrentCatalogItemId, new { @type = "number", @min = "1", @max = "100", @required = "required", @Value = "1", @class = "add-to-cart-qty-input" })
                                        <input value="1" class="add-to-cart-qty-input" data-val="true" data-val-number="The field Quantity must be a number." data-val-required="The Quantity field is required." id="Quantity" max="100" min="1" name="Quantity" required="required" type="number">
                                        <button type="button" class="increase" style="display: none"></button>
                                    </div>
                                </div>
                                @*@Html.ValidationMessageFor(model => model.Quantity)*@
                                <div class="add-to-cart-button">
                                    <button type="submit" class="add-to-cart-btn" data-loading-text="@addingToCartLabel" disabled="disabled">
                                        @addToCartLabel
                                    </button>
                                </div>
}
                                </div>
                            </div>
                        </div>
                    </li>
            </ul>
        </div>

        <!-- ko if: useLazyLoading -->
        <button class="btn btn-block" data-bind="click: loadMoreProducts, visible:canLoadMoreProducts" title="@currentItem["Show More Products Tooltip"]">@loadMoreProductsText</button>
        <!-- /ko -->
    }
</div>
